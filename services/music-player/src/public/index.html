<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4a9eff;
        }

        .player-controls {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        .now-playing {
            text-align: center;
            margin-bottom: 15px;
        }

        .song-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .song-artist {
            color: #aaa;
            font-size: 0.9em;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        button:hover {
            background: #357abd;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time {
            font-size: 0.9em;
            color: #aaa;
            min-width: 45px;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: #555;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: #4a9eff;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #aaa;
        }

        .skeleton-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #3a3a3a;
        }

        .skeleton-info {
            flex: 1;
        }

        .skeleton-line {
            height: 16px;
            background: linear-gradient(90deg, #3a3a3a 25%, #4a4a4a 50%, #3a3a3a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .skeleton-line.short {
            width: 60%;
        }

        .skeleton-line.long {
            width: 80%;
        }

        .skeleton-duration {
            width: 50px;
            height: 16px;
            background: linear-gradient(90deg, #3a3a3a 25%, #4a4a4a 50%, #3a3a3a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .load-more {
            text-align: center;
            padding: 20px;
        }

        .load-more button {
            background: #2a2a2a;
            border: 1px solid #555;
            padding: 12px 24px;
        }

        .load-more button:hover {
            background: #3a3a3a;
        }

        .song-list {
            background: #2a2a2a;
            border-radius: 10px;
            overflow: hidden;
        }

        .song-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #3a3a3a;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .song-item:hover {
            background: #3a3a3a;
        }

        .song-item.playing {
            background: #1a4a7a;
        }

        .song-item:last-child {
            border-bottom: none;
        }

        .song-info {
            flex: 1;
        }

        .song-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .song-details {
            font-size: 0.9em;
            color: #aaa;
        }

        .song-duration {
            color: #aaa;
            font-size: 0.9em;
            min-width: 60px;
            text-align: right;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
            font-size: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .stats {
            text-align: center;
            margin-bottom: 20px;
            color: #aaa;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Music Player</h1>
        
        <div class="player-controls">
            <div class="now-playing">
                <div class="song-title" id="currentTitle">No song selected</div>
                <div class="song-artist" id="currentArtist"></div>
            </div>
            
            <div class="controls">
                <button id="prevBtn" disabled>‚èÆÔ∏è Previous</button>
                <button id="playPauseBtn" disabled>‚ñ∂Ô∏è Play</button>
                <button id="nextBtn" disabled>‚è≠Ô∏è Next</button>
            </div>
            
            <div class="progress-container">
                <span class="time" id="currentTime">0:00</span>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span class="time" id="totalTime">0:00</span>
            </div>
            
            <audio id="audioPlayer" preload="none"></audio>
        </div>

        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="Search songs, artists, or albums...">
        </div>

        <div class="stats" id="stats">Loading music library...</div>

        <div class="load-more" id="loadMoreContainer" style="display: none;">
            <button id="loadMoreBtn">Load More Songs</button>
        </div>

        <div class="song-list" id="songList">
            <div class="loading">Loading songs...</div>
        </div>
    </div>

    <script>
        class MusicPlayer {
            constructor() {
                this.allSongs = []; // All loaded songs
                this.displayedSongs = []; // Currently displayed songs
                this.currentIndex = -1;
                this.isPlaying = false;
                this.currentPage = 1;
                this.totalSongs = 0;
                this.hasMorePages = true;
                this.isLoading = false;
                this.currentSearch = '';
                this.searchTimeout = null;
                
                this.audioPlayer = document.getElementById('audioPlayer');
                this.playPauseBtn = document.getElementById('playPauseBtn');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.progressBar = document.getElementById('progressBar');
                this.progressFill = document.getElementById('progressFill');
                this.currentTime = document.getElementById('currentTime');
                this.totalTime = document.getElementById('totalTime');
                this.currentTitle = document.getElementById('currentTitle');
                this.currentArtist = document.getElementById('currentArtist');
                this.songList = document.getElementById('songList');
                this.searchInput = document.getElementById('searchInput');
                this.stats = document.getElementById('stats');
                this.loadMoreContainer = document.getElementById('loadMoreContainer');
                this.loadMoreBtn = document.getElementById('loadMoreBtn');
                
                this.initializeEventListeners();
                this.loadInitialData();
            }

            initializeEventListeners() {
                this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
                this.prevBtn.addEventListener('click', () => this.previousSong());
                this.nextBtn.addEventListener('click', () => this.nextSong());
                
                this.progressBar.addEventListener('click', (e) => this.seekTo(e));
                
                this.audioPlayer.addEventListener('timeupdate', () => this.updateProgress());
                this.audioPlayer.addEventListener('ended', () => this.nextSong());
                this.audioPlayer.addEventListener('loadedmetadata', () => this.updateDuration());
                
                this.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
                this.loadMoreBtn.addEventListener('click', () => this.loadMoreSongs());
                
                // Infinite scroll detection
                window.addEventListener('scroll', () => this.handleScroll());
            }

            async loadInitialData() {
                try {
                    // Get total count first
                    const countResponse = await fetch('/api/songs/count');
                    const countData = await countResponse.json();
                    this.totalSongs = countData.count;
                    
                    // Load first page
                    await this.loadSongs(1, '');
                } catch (error) {
                    console.error('Failed to load initial data:', error);
                    this.songList.innerHTML = '<div class="loading">Failed to load songs</div>';
                }
            }

            async loadSongs(page = 1, search = '', append = false) {
                if (this.isLoading) return;
                
                this.isLoading = true;
                
                try {
                    const params = new URLSearchParams({
                        page: page.toString(),
                        limit: '50',
                        search: search
                    });
                    
                    if (!append) {
                        this.showSkeletonLoader();
                    }
                    
                    const response = await fetch(`/api/songs?${params}`);
                    const data = await response.json();
                    
                    if (append) {
                        this.allSongs.push(...data.songs);
                        this.displayedSongs.push(...data.songs);
                    } else {
                        this.allSongs = data.songs;
                        this.displayedSongs = data.songs;
                    }
                    
                    this.currentPage = data.pagination.page;
                    this.hasMorePages = data.pagination.hasNext;
                    this.totalSongs = data.pagination.totalSongs;
                    
                    this.renderSongs();
                    this.updateStats();
                    this.updateLoadMoreButton();
                    
                } catch (error) {
                    console.error('Failed to load songs:', error);
                    if (!append) {
                        this.songList.innerHTML = '<div class="loading">Failed to load songs</div>';
                    }
                } finally {
                    this.isLoading = false;
                }
            }

            async loadMoreSongs() {
                if (!this.hasMorePages || this.isLoading) return;
                await this.loadSongs(this.currentPage + 1, this.currentSearch, true);
            }

            handleSearch(query) {
                // Debounce search
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    this.currentSearch = query;
                    this.currentPage = 1;
                    this.loadSongs(1, query, false);
                }, 300);
            }

            handleScroll() {
                if (this.isLoading || !this.hasMorePages) return;
                
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;
                
                // Load more when user is 200px from bottom
                if (scrollTop + windowHeight >= documentHeight - 200) {
                    this.loadMoreSongs();
                }
            }

            showSkeletonLoader() {
                const skeletonItems = Array(10).fill(0).map(() => `
                    <div class="skeleton-item">
                        <div class="skeleton-info">
                            <div class="skeleton-line long"></div>
                            <div class="skeleton-line short"></div>
                        </div>
                        <div class="skeleton-duration"></div>
                    </div>
                `).join('');
                
                this.songList.innerHTML = skeletonItems;
            }

            renderSongs() {
                if (this.displayedSongs.length === 0) {
                    this.songList.innerHTML = '<div class="loading">No songs found</div>';
                    return;
                }

                this.songList.innerHTML = this.displayedSongs.map((song, index) => `
                    <div class="song-item" data-index="${index}" onclick="player.playSong(${index})">
                        <div class="song-info">
                            <div class="song-name">${this.escapeHtml(song.title)}</div>
                            <div class="song-details">${this.escapeHtml(song.artist)} ‚Ä¢ ${this.escapeHtml(song.album)}</div>
                        </div>
                        <div class="song-duration">${this.formatTime(song.duration)}</div>
                    </div>
                `).join('');
            }

            updateLoadMoreButton() {
                if (this.hasMorePages && this.displayedSongs.length > 0) {
                    this.loadMoreContainer.style.display = 'block';
                    this.loadMoreBtn.textContent = this.isLoading ? 'Loading...' : 'Load More Songs';
                    this.loadMoreBtn.disabled = this.isLoading;
                } else {
                    this.loadMoreContainer.style.display = 'none';
                }
            }

            updateStats() {
                const displayed = this.displayedSongs.length;
                const total = this.totalSongs;
                const totalDuration = this.displayedSongs.reduce((sum, song) => sum + song.duration, 0);
                
                let statsText = `Showing ${displayed} of ${total} songs`;
                if (totalDuration > 0) {
                    statsText += ` ‚Ä¢ ${this.formatTime(totalDuration)} loaded`;
                }
                if (this.currentSearch) {
                    statsText += ` ‚Ä¢ Filtered by "${this.currentSearch}"`;
                }
                
                this.stats.textContent = statsText;
            }

            playSong(index) {
                if (index < 0 || index >= this.displayedSongs.length) return;
                
                this.currentIndex = index;
                const song = this.displayedSongs[index];
                
                this.audioPlayer.src = song.audioUrl;
                this.audioPlayer.load();
                
                this.currentTitle.textContent = song.title;
                this.currentArtist.textContent = `${song.artist} ‚Ä¢ ${song.album}`;
                
                this.updatePlayingState();
                this.audioPlayer.play();
                this.isPlaying = true;
                this.playPauseBtn.textContent = '‚è∏Ô∏è Pause';
                
                this.enableControls();
            }

            togglePlayPause() {
                if (this.currentIndex === -1) return;
                
                if (this.isPlaying) {
                    this.audioPlayer.pause();
                    this.isPlaying = false;
                    this.playPauseBtn.textContent = '‚ñ∂Ô∏è Play';
                } else {
                    this.audioPlayer.play();
                    this.isPlaying = true;
                    this.playPauseBtn.textContent = '‚è∏Ô∏è Pause';
                }
            }

            previousSong() {
                if (this.currentIndex > 0) {
                    this.playSong(this.currentIndex - 1);
                }
            }

            nextSong() {
                if (this.currentIndex < this.displayedSongs.length - 1) {
                    this.playSong(this.currentIndex + 1);
                } else if (this.hasMorePages) {
                    // Auto-load more songs if we're at the end and there are more
                    this.loadMoreSongs().then(() => {
                        if (this.currentIndex < this.displayedSongs.length - 1) {
                            this.playSong(this.currentIndex + 1);
                        }
                    });
                }
            }

            seekTo(e) {
                if (this.currentIndex === -1) return;
                
                const rect = this.progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const seekTime = percent * this.audioPlayer.duration;
                this.audioPlayer.currentTime = seekTime;
            }

            updateProgress() {
                if (this.audioPlayer.duration) {
                    const percent = (this.audioPlayer.currentTime / this.audioPlayer.duration) * 100;
                    this.progressFill.style.width = percent + '%';
                    this.currentTime.textContent = this.formatTime(this.audioPlayer.currentTime);
                }
            }

            updateDuration() {
                this.totalTime.textContent = this.formatTime(this.audioPlayer.duration);
            }

            updatePlayingState() {
                document.querySelectorAll('.song-item').forEach((item, index) => {
                    item.classList.toggle('playing', index === this.currentIndex);
                });
            }

            enableControls() {
                this.playPauseBtn.disabled = false;
                this.prevBtn.disabled = this.currentIndex <= 0;
                this.nextBtn.disabled = this.currentIndex >= this.displayedSongs.length - 1 && !this.hasMorePages;
            }

            formatTime(seconds) {
                if (!seconds || isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize the music player
        const player = new MusicPlayer();
    </script>
</body>
</html>
